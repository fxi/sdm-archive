
<!DOCTYPE html>
<html>
	<head>
		<title>Animated map</title>
		<meta charset="utf-8" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<!--<link rel="stylesheet" href="style.css" />-->
		<link rel="stylesheet" href="leaflet/css/map.css" />
		<link rel="stylesheet" href="leaflet/css/leaflet.css" />
		<link rel="stylesheet" href="leaflet/css/leaflet.ie.css" />
		<link rel="stylesheet" href="leaflet/css/scale.css" />
		<link rel="stylesheet" href="leaflet/Leaflet.label/dist/leaflet.label.css" />

	</head>
	<body>
 <h3>animMap</h3>
 <p>Presence probabilities map for Allogamus auricollis from 1992 to 2050, based on prediction extracted from a random forest model (Proof of concept only)</p>
 <a href='http://sdm.unige.ch'> Back to sdm.unige.ch </a>
		<div id="map" style="width: 100%; height: 800px"></div>

		<script src="leaflet/leaflet.js"></script>
		<script src="leaflet/leaflet-providers.js"></script>
		<script src="leaflet/leaflet.ajax.min.js"></script>
		<script src="leaflet/Leaflet.label/dist/leaflet.label.js"></script>
		<!--<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>-->
		<script>
			// functions 
			// create array
			function makeArray(count, content) {
				var result = [];
				if(typeof(content) == "function") {
					for(var i=0; i<count; i++) {
						result.push(content(i));
					}
					} else {
					for(var i=0; i<count; i++) {
						result.push(content);
					}
				}
				return result;
			}


			//

			var map = L.map('map').setView([46.23685258143992, 7.779693603515625], 9);
			// osm cycle map as base layer
			var thunderForest = L.tileLayer.provider('Thunderforest.Landscape', {}).addTo(map);
			var nokiaSatellite = L.tileLayer.provider('Nokia.satelliteNoLabelsDay',{
				appID:'FsATXbDh2ExvebrwnMHe',
				devID:'KKOcYF8Zpq8lBluxXaOCUg'
			});
			var osmMapnik = L.tileLayer.provider('OpenStreetMap.Mapnik',{});
			var toner = L.tileLayer.provider('Stamen.Toner',{});
			var baseLayers = {
				"Landscape (ThunderForest / Open Cycle Map)": thunderForest,
				"Open Street Map (Mapnik / Open Street Map)" : osmMapnik,
				"Satellite day. (Nokia)":nokiaSatellite,
				"Toner (Stamen, Open Street Map)":toner
			};
			L.control.scale({maxWidth:500, imperial:false, updateWhenIdle:true}).addTo(map);

			function changeOpac (n){

				var setOpac=0.5
			}

			var yearSeq=makeArray(2051-1992, function(i){return 1992+i});
			var arrayLength = yearSeq.length;
			function clearHexaGrid() {
				map.removeLayer(geojsonLayer);
				console.log('removed')
			};

			function popUp(feature, layer) {
				layer.bindLabel(feature.properties.probPresTxt)
				//layer.bindPopup(feature.properties.name);
			};


			function getColorHeat(d) {
				return d > 0.875 ? '#800026' :
				d > 0.75  ? '#BD0026' :
				d > 0.625  ? '#E31A1C' :
				d > 0.5  ? '#FC4E2A' :
				d > 0.375   ? '#FD8D3C' :
				d > 0.25   ? '#FEB24C' :
				d > 0.125   ? '#FED976' :
				'#FFEDA0';
			}


			function probStyle(feature){
				prob = feature.properties.PRES
				return{
					fillColor:getColorHeat(prob),
					weight:0
					//opacity:setOpac
				};


			}


			// populate group layer
			function populateHexGrid (a){
				// keep original value
				var gLayer=new L.GeoJSON.AJAX("./geoJSON/"+yearSeq[a-1]+".GeoJSON", {
					style: probStyle,
					onEachFeature:popUp});
				hexGroup.addLayer(gLayer);
				if (--a) populateHexGrid(a); // decrement i and call function again 
			}


			function animHexGrid (h,interval){
				hL=h.length;
				hOrig=h,
				a=0;
				var tid = setInterval(anim, interval);
				function anim () {
console.log(yearSeq[a])
					// if a map is alread displayed, remove it
					if(a>0){
						map.removeLayer(h[a-1])
					}
					// add layer from array
					h[a].addTo(map);
					a++;
					// if this is the last one, 
					// display it and set counter to 0
					if(a==hL){		
						map.removeLayer(h[a-1]);
						a=0;
						h[a].addTo(map);
						a++;}

				};


			}
			// new group layer
			hexGroup = new L.LayerGroup() ;
			// get files into layers groups
			populateHexGrid(arrayLength);
			// get an array with layers
			hexArray=hexGroup.getLayers();
			// launch animation
			animHexGrid(hexArray,500);

			//// LEGENDS
			var legend = L.control({position: 'bottomright'});
			var legendType = 'heat';
			legend.onAdd = function (map) {
				if(legendType=='heat'){
					var div = L.DomUtil.create('div', 'info legend'),
					grades = [0,0.125,0.25,0.375,0.5,0.625,0.75,0.875],
					labels = [];
					// loop through our density intervals and generate a label with a colored square for each interval
					for (var i = 0; i < grades.length; i++) {
						div.innerHTML +=
						'<i style="background:' + getColorHeat(grades[i]) + '"></i> ' +
						grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
					}
					return div;
					}else{
					var div = L.DomUtil.create('div', 'info legend'),
					//grades = [-1,-0.8,-0.6,-0.4,-0.2,0.01,0.21,0.41,0.61,0.81],
					grades = [0.81,0.61,0.41,0.21,0.01,-0.20,-0.4,-0.6,-0.8,-1],
					gradesTo = [0.80,0.60,0.40,0.19,0.00,-0.19,-0.39,-0.59,-0.79,-0.99],
					labels = [];
					// loop through our density intervals and generate a label with a colored square for each interval
					// div.innnerHTML='Diff. Prob. 1991-2008 to 1980-1990<br>'
					for (var i = 0; i < grades.length; i++) {
						div.innerHTML +=
						'<i style="background:' + getColorDiverg(grades[i]) + '"></i> ' +
						grades[i]+ (grades[i - 1] ? ' -> ' + gradesTo[i - 1] + '<br>' : ' -> 1 <br>');
					}
					return div;
				};
			};
			legend.addTo(map);




			//	var overlays = {
				//	};
			//		layersControl = new L.Control.Layers(baseLayers, overlays, {
				//			collapsed: true
				//		});
			//		map.addControl(layersControl);>


			//			function paletteProb(feature) {
				//				if(feature.properties.PRES>0.5){
					//					return {
						//						fillColor:'#FF0000',
						//						weight:0
						//					};
					//					}else{
					//					return{
						//						fillColor:'#008080',
						//						weight:0
						//					}
					//				};
				//
				//			};


		</script>
	</body>
</html>

